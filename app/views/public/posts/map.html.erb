<div class="container mt-5">
  <h2 class="text-center mb-4"><i class="fas fa-bicycle text-primary"></i> みんなのサイクリングマップ</h2>
  
  <% #地図を表示するエリア %>
  <div id="all-map" style="height: 600px; width: 100%;" class="rounded shadow border"></div>

  <div class="mt-3 text-right text-muted small">
    ※ピンをクリックすると投稿詳細へ移動します
  </div>
</div>

<% #APIの読み込み %>
<script async src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap"></script>

<script>
  function initMap() {
    const center = { lat: 35.681236, lng: 139.767125 };
    const map = new google.maps.Map(document.getElementById("all-map"), {
      center: center,
      zoom: 10,
    });

    const infoWindow = new google.maps.InfoWindow();

    <% @posts.each do |post| %>
      (function() {
        const markerPos = { lat: <%= post.latitude %>, lng: <%= post.longitude %> };
        const marker = new google.maps.Marker({
          position: markerPos,
          map: map,
          title: "<%= j post.address %>"
        });

        marker.addListener("click", () => {
          const contentString = `
            <div class="map-info-window" style="max-width: 200px;">
              <% if post.image.attached? %>
                <img src="<%= url_for(post.image.variant(resize_to_limit: [200, 200])) %>" style="width: 100%; height: auto; border-radius: 4px; margin-bottom: 8px;">
              <% end %>
              <h6 style="margin: 0 0 5px 0; font-weight: bold;"><%= j post.title %></h6>
              <p style="font-size: 12px; color: #666; margin-bottom: 8px;"><%= j truncate(post.body, length: 30) %></p>
              <a href="<%= post_path(post) %>" class="btn btn-primary btn-sm" style="color: #fff; text-decoration: none; display: block; text-align: center;">詳細を見る</a>
            </div>
          `;

          infoWindow.setContent(contentString);
          infoWindow.open(map, marker);
        });
      })();
    <% end %>
  }
</script>