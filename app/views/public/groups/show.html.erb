<div class="container mt-5">
  <div class="row border-bottom pb-3 mb-4 align-items-end">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        <span class="badge badge-pill badge-primary mr-2 px-3"><%= @group.genre.name %></span>
        <h2 class="mb-0 font-weight-bold"><%= @group.name %></h2>
      </div>
      <p class="text-muted small mt-2 mb-0">作成者: <%= @group.owner.name %> さん</p>
    </div>
    <div class="col-md-4 text-md-right mt-3 mt-md-0">
      <% if @group.owner_id == current_user.id %>
        <%= link_to edit_group_path(@group), class: "btn btn-outline-secondary btn-sm" do %>
          <i class="fas fa-cog"></i> グループ編集
        <% end %>
        <%= link_to new_group_event_notices_path(@group), class: "btn btn-info btn-sm shadow-sm ml-1" do %>
          <i class="fas fa-envelope"></i> メールを作成する
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="row mb-4 d-flex align-items-stretch">
    <% #グループ紹介 %>
    <div class="col-md-8">
      <div class="h-100 d-flex flex-column">
        <h5 class="font-weight-bold">グループ紹介</h5>
        <div class="p-4 bg-white rounded border shadow-sm flex-grow-1">
          <%= simple_format(@group.description) %>
        </div>
      </div>
    </div>

    <% #ステータス・申請 %>
    <div class="col-md-4 mt-4 mt-md-0">
      <div class="h-100 d-flex flex-column">
        <h5 class="font-weight-bold text-muted">現在のステータス</h5>
        <div class="card shadow-sm border-0 flex-grow-1">
          <div class="card-body d-flex flex-column justify-content-center">
            <% if @group.owner_id != current_user.id %>
              <% group_user = current_user.group_users.find_by(group_id: @group.id) %>
              <% if group_user.nil? %>
                <% if current_user.guest_user? %>
                  <div class="text-center py-2">
                    <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                    <p class="text-muted small mb-3">グループに参加するには、<br>新規登録またはログインが必要です。</p>
                  </div>
                <% else %>
                  <p class="text-center text-muted small">このグループに参加して交流しましょう！</p>
                  <%= link_to 'このグループに参加申請', group_group_users_path(@group), method: :post, class: "btn btn-primary btn-block shadow-sm" %>
                <% end %>
              <% elsif group_user.pending? %>
                <div class="text-center">
                  <i class="fas fa-hourglass-half fa-2x text-secondary mb-3"></i>
                  <p class="mb-0">現在、承認待ちです</p>
                </div>
              <% elsif group_user.approved? %>
                <div class="text-center">
                  <div class="alert alert-success py-2 mb-3">参加中</div>
                  <%= link_to 'グループを退会する', group_group_user_path(@group, group_user), method: :delete, data: { confirm: "本当に退会しますか？" }, class: "btn btn-sm btn-link text-danger" %>
                </div>
              <% end %>
            <% else %>
              <div class="text-center">
                <div class="alert alert-warning py-2 mb-0">あなたはオーナーです</div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% #掲示板とメンバーリスト %>
  <div class="row">
    <% #チャット %>
    <div class="col-md-8">
      <% if @group.group_users.approved.exists?(user_id: current_user.id) || @group.owner_id == current_user.id %>
        <h5 class="font-weight-bold">グループ掲示板</h5>
        <div class="card shadow-sm mb-3">
          <div id="group-posts-index" class="card-body p-3" style="min-height: 250px; max-height: 500px; overflow-y: auto;">
            <%= render 'public/group_posts/index', group: @group %>
          </div>
          <div class="card-footer bg-white border-top-0">
            <%= form_with model: [@group, GroupPost.new], local: false, class: "mb-0" do |f| %>
              <div class="input-group">
                <%= f.text_area :body, class: "form-control border-0 bg-light", placeholder: "メッセージを入力...", rows: 1 %>
                <div class="input-group-append">
                  <%= f.submit "送信", class: "btn btn-primary" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <% #メンバーリストと承認待ち %>
    <div class="col-md-4 mt-4 mt-md-0">
      <% # 承認待ち %>
      <% if @group.owner_id == current_user.id && @group.group_users.pending.exists? %>
        <div class="card mb-4 border-warning shadow-sm">
          <div class="card-header bg-warning text-dark font-weight-bold small py-2">承認待ちの申請</div>
          <ul class="list-group list-group-flush small">
            <% @group.group_users.pending.each do |gu| %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <%= gu.user.name %>
                <div>
                  <%= link_to '承認', group_group_user_path(@group, gu), method: :patch, class: "text-success mr-2 font-weight-bold" %>
                  <%= link_to '拒否', group_group_user_path(@group, gu), method: :delete, class: "text-danger" %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% #メンバーリスト %>
      <div class="card shadow-sm">
        <div class="card-header bg-white font-weight-bold d-flex justify-content-between align-items-center">
          <span>参加メンバー</span>
          <span class="badge badge-light border"><%= @group.group_users.approved.count %>人</span>
        </div>
        <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
          <ul class="list-group list-group-flush">
            <% @group.group_users.approved.each do |gu| %>
              <li class="list-group-item d-flex align-items-center">
                <i class="fas fa-user-circle text-muted mr-2"></i>
                <span class="text-truncate mr-auto"><%= gu.user.name %></span>
                <% if gu.user == @group.owner %>
                  <span class="badge badge-warning" style="font-size: 0.7rem;">オーナー</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>